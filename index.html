<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>校正ツール</title>

  <!-- ✅ ファビコン（同階層に favicon.png を置く。更新時は ?v=2 等でキャッシュ回避） -->
  <link rel="icon" href="favicon.png?v=1" type="image/png">

  <style>
    :root{
      --bg:#111; --panel:#181818; --ink:#f3f4f6; --muted:#a8b0bb;
      --border:#2f2f2f; --accent:#86b3ff;
      --hit:#ff6b6b;         /* 通常ハイライト（赤） */
      --hit-active:#46e6c2;  /* 選択中のみ色 */
      --table-line:#3a3a3a;  /* 表の枠線 */
      --zebra:#151515;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;background:#1a1a1a;border-bottom:1px solid var(--border);z-index:20}
    header .wrap{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;gap:12px;align-items:center}
    h1{margin:0;font-size:18px}
    .container{max-width:1100px;margin:0 auto;padding:12px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .card .hd{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .card .bd{padding:12px}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    button{appearance:none;border:1px solid #3a3a3a;background:#222;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    button:hover{background:#2a2a2a}
    .btn-ghost{background:transparent}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    input[type=text],select,textarea{
      width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:#0b0b0b;color:var(--ink)
    }
    textarea{min-height:160px}
    .out{background:#0b0b0b;border:1px solid var(--border);border-radius:8px;padding:12px;min-height:120px;white-space:pre-wrap;line-height:1.7;max-height:420px;overflow:auto}
    mark.hit{background:transparent;color:var(--hit);padding:0 1px;border-bottom:2px solid var(--hit)}
    mark.hit.active{color:var(--hit-active);border-color:var(--hit-active)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#cbd5e1}
    .kbd{font:12px ui-monospace;background:#171717;border:1px solid #2b2b2b;border-bottom-width:2px;padding:2px 6px;border-radius:8px}
    .space{height:8px}

    /* ===== 右ドロワー（用語一覧） ===== */
    .drawer{position:fixed;top:0;right:0;height:100%;width:640px;max-width:96vw;background:#121212;border-left:1px solid var(--border);transform:translateX(100%);transition:transform .22s ease;z-index:40;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawer .hd{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center}
    .drawer .bd{padding:10px 12px;overflow:auto;display:flex;flex-direction:column;gap:10px}

    /* 開閉ハンドル（◁ / ▷ を切り替え）*/
    .drawerHandle{
      position:fixed;right:0;top:50%;transform:translateY(-50%);
      background:#1a1a1a;border:1px solid var(--border);border-right:none;border-top-left-radius:10px;border-bottom-left-radius:10px;
      padding:10px 10px;color:var(--ink);cursor:pointer;z-index:41;user-select:none
    }

    /* タブ */
    .tabs{display:flex;flex-wrap:wrap;gap:6px}
    .tab{border:1px solid var(--border);background:#161616;color:#d1d5db;padding:6px 10px;border-radius:999px;cursor:pointer;font-size:13px}
    .tab.active{background:#243043;border-color:#37517a;color:#e8f0ff}
    .tab .count{font-size:12px;color:#aab2bf;margin-left:6px}

    /* 検索ボックス */
    .searchRow{display:flex;gap:8px;align-items:center}
    .searchRow input[type=text]{flex:1}

    /* テーブル（枠線強めで“表計算”感） */
    .tableWrap{border:1px solid var(--table-line);border-radius:8px;overflow:auto;background:#0e0e0e}
    table.terms{width:100%;border-collapse:collapse;min-width:520px}
    table.terms thead th{position:sticky;top:0;background:#161616;border-bottom:2px solid var(--table-line);padding:8px 10px;text-align:left}
    table.terms td{padding:8px 10px;border-bottom:1px solid var(--table-line);vertical-align:top}
    table.terms tr:nth-child(even){background:var(--zebra)}
    .td-initial{width:64px;font-weight:700;color:#e5e7eb}
    .td-word{width:40%}
    .td-suggest{width:40%}
    .td-del{width:42px}
    .del{color:#fda4af;border:none;background:transparent;cursor:pointer;font-size:16px;line-height:1}

    /* 小さな補助 */
    .muted-sm{color:#a8b0bb;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>校正ツール</h1>
      <div class="muted" style="margin-left:auto">
        <span class="kbd">Ctrl/Cmd + Enter</span> で実行 ／
        <span class="kbd">Alt + ←/→</span> で前後ジャンプ
      </div>
    </div>
  </header>

  <main class="container">
    <!-- 入力 -->
    <section class="card">
      <div class="hd">
        <strong>テキスト入力</strong>
        <div class="row" style="align-items:center">
          <button id="runBtn">実行</button>
          <button id="clearBtn" class="btn-ghost">入力クリア</button>
        </div>
      </div>
      <div class="bd">
        <textarea id="input" placeholder="ここに本文を貼り付け"></textarea>
      </div>
    </section>

    <div class="space"></div>

    <!-- 登録フォーム（常時表示） -->
    <section class="card">
      <div class="hd">
        <strong>用語の登録（常時表示）</strong>
        <span class="muted">※ 登録内容はブラウザに保存されます</span>
      </div>
      <div class="bd">
        <div class="row">
          <div class="col">
            <label>ハイライトするキーワード
              <input type="text" id="f-term" placeholder="例：時々">
            </label>
          </div>
          <div class="col">
            <label>推奨表記（任意）
              <input type="text" id="f-suggest" placeholder="例：ときどき">
            </label>
          </div>
          <div class="col">
            <label>読み（ひらがな・必須）
              <input type="text" id="f-yomi" placeholder="例：ときどき">
            </label>
          </div>
          <div class="col">
            <label>品詞
              <select id="f-pos">
                <option>名詞</option>
                <option>動詞</option>
                <option>形容詞</option>
                <option>形容動詞</option>
                <option selected>副詞</option>
                <option>連体詞</option>
                <option>接続詞</option>
                <option>助詞</option>
                <option>助動詞</option>
                <option>感動詞</option>
                <option>記号</option>
                <option>その他</option>
              </select>
            </label>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="addBtn">用語を登録</button>
        </div>
      </div>
    </section>

    <div class="space"></div>

    <!-- 校正結果 -->
    <section class="card">
      <div class="hd">
        <strong>校正結果</strong>
        <div class="row" style="align-items:center">
          <span id="countPill" class="pill">問題: 0件</span>
          <!-- 2. ジャンプボタン（← / →） -->
          <button id="prevBtn" title="前へ（Alt+←）">←</button>
          <button id="nextBtn" title="次へ（Alt+→）">→</button>
          <span id="hitState" class="muted mono" style="min-width:64px;text-align:right"></span>
        </div>
      </div>
      <div class="bd">
        <div id="highlight" class="out"></div>
        <div class="space"></div>
        <div class="out" style="padding:0">
          <table>
            <thead>
              <tr>
                <th style="width:90px">行:列</th>
                <th style="width:140px">ルール</th>
                <th>指摘</th>
                <th style="width:180px">提案</th>
                <th style="width:260px">文脈</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- 右側ドロワー：品詞タブ＋検索＋表（読み頭文字｜用語｜推奨｜×） -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="hd">
      <strong>用語一覧</strong>
      <span class="muted-sm">（品詞タブ／読み順）</span>
    </div>
    <div class="bd">
      <!-- タブ -->
      <div id="tabs" class="tabs"></div>

      <!-- 検索 -->
      <div class="searchRow">
        <input id="searchBox" type="text" placeholder="検索（用語・推奨表記にマッチ）">
        <span id="tabCount" class="muted-sm"></span>
      </div>

      <!-- 表 -->
      <div class="tableWrap">
        <table class="terms">
          <thead>
            <tr>
              <th class="td-initial">読み</th>
              <th class="td-word">チェック</th>
              <th class="td-suggest">推奨表記</th>
              <th class="td-del">削除</th>
            </tr>
          </thead>
          <tbody id="termsTbody"></tbody>
        </table>
      </div>
    </div>
  </aside>

  <!-- ◁ / ▷：開閉兼用ハンドル（記号のみ） -->
  <button id="drawerHandle" class="drawerHandle" aria-label="用語一覧を開く">◁</button>

<script>
/* =========================
   ストレージ / データ構造
========================= */
const LS_KEY = 'proof_terms.v4';
/** term = {
 *  id: number, term: string, suggest: string,
 *  yomi: string(ひらがな), pos: string, enabled: true
 * }
 */
let terms = [];

const POS_ORDER = [
  '副詞','形容詞','名詞','動詞','形容動詞','連体詞','接続詞','助詞','助動詞','感動詞','記号','その他'
];

/* =========================
   DOM 参照
========================= */
const $input = document.getElementById('input');
const $highlight = document.getElementById('highlight');
const $tbody = document.getElementById('tableBody');
const $countPill = document.getElementById('countPill');
const $hitState = document.getElementById('hitState');

const $run = document.getElementById('runBtn');
const $clear = document.getElementById('clearBtn');
const $prev = document.getElementById('prevBtn');
const $next = document.getElementById('nextBtn');

const $fTerm = document.getElementById('f-term');
const $fSug  = document.getElementById('f-suggest');
const $fYomi = document.getElementById('f-yomi');
const $fPos  = document.getElementById('f-pos');
const $add   = document.getElementById('addBtn');

const $drawer = document.getElementById('drawer');
const $drawerHandle = document.getElementById('drawerHandle');

const $tabs = document.getElementById('tabs');
const $search = document.getElementById('searchBox');
const $tabCount = document.getElementById('tabCount');
const $termsTbody = document.getElementById('termsTbody');

/* =========================
   初期化
========================= */
let activePos = POS_ORDER[0]; // デフォルトは先頭の品詞タブ
(function init(){
  const raw = localStorage.getItem(LS_KEY);
  if(raw){ try{ terms = JSON.parse(raw) || []; }catch{} }
  if(!terms.length){
    // 体験用サンプル
    terms = [
      { id: 1, term:'...', suggest:'……', yomi:'てんてんてん', pos:'記号', enabled:true },
      { id: 2, term:'時々', suggest:'ときどき', yomi:'ときどき', pos:'副詞', enabled:true },
      { id: 3, term:'又は', suggest:'または', yomi:'または', pos:'接続詞', enabled:true },
      { id: 4, term:'稀に', suggest:'まれに', yomi:'まれに', pos:'副詞', enabled:true }
    ];
    saveTerms();
  }
  renderTabs();
  renderTermsTable();
})();

/* =========================
   ユーティリティ
========================= */
function saveTerms(){ localStorage.setItem(LS_KEY, JSON.stringify(terms)); }
function escapeHtml(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function toLineCol(text, index){ let line=1,col=1; for(let i=0;i<index;i++){ if(text[i]==='\n'){ line++; col=1; } else col++; } return {line,col}; }
function getCtx(text, start, end, pad=16){ const s=Math.max(0,start-pad), e=Math.min(text.length,end+pad); const L=text.slice(s,start), M=text.slice(start,end), R=text.slice(end,e); return `${L}[${M}]${R}`.replace(/\n/g,'⏎'); }
function escapeReg(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function isHiragana(s){ return /^[ぁ-ゖー]+$/.test(s); } // ひらがな + 長音
function initialKana(yomi){
  // 読みの先頭を正規化して「段」見出しに使う
  if(!yomi) return 'その他';
  const ch = yomi[0];
  const map = {'ゔ':'う','が':'か','ぎ':'き','ぐ':'く','げ':'け','ご':'こ','ざ':'さ','じ':'し','ず':'す','ぜ':'せ','ぞ':'そ','だ':'た','ぢ':'ち','づ':'つ','で':'て','ど':'と','ば':'は','び':'ひ','ぶ':'ふ','べ':'へ','ぼ':'ほ','ぱ':'は','ぴ':'ひ','ぷ':'ふ','ぺ':'へ','ぽ':'ほ','ゃ':'や','ゅ':'ゆ','ょ':'よ','ぁ':'あ','ぃ':'い','ぅ':'う','ぇ':'え','ぉ':'お','っ':'つ'};
  const base = map[ch] || ch;
  const set = 'あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん';
  return set.includes(base) ? base : 'その他';
}
function kanaSortKey(y){ return y || ''; }

/* =========================
   3 & 7: 用語登録 / テーブル
========================= */
// 登録
$add.addEventListener('click', ()=>{
  const t = ($fTerm.value||'').trim();
  const y = ($fYomi.value||'').trim();
  if(!t) return alert('「ハイライトするキーワード」を入力してください');
  if(!y) return alert('「読み（ひらがな）」は必須です');
  if(!isHiragana(y)) return alert('読みは ひらがな で入力してください');

  const obj = { id: Date.now(), term: t, suggest: ($fSug.value||'').trim(), yomi: y, pos: $fPos.value, enabled: true };
  terms.push(obj);
  saveTerms();

  // UI反映：該当品詞タブへ切替 → ドロワーを開いてその段へスクロール
  activePos = obj.pos;
  renderTabs();
  renderTermsTable();
  openDrawer();
  // 段の一番上へ
  const row = document.querySelector(`[data-init="${initialKana(obj.yomi)}"]`);
  if(row){ row.scrollIntoView({behavior:'smooth', block:'start'}); }

  // 入力リセット
  $fTerm.value = $fSug.value = $fYomi.value = '';
});

// タブ描画
function renderTabs(){
  // 各品詞の件数
  const counts = {};
  POS_ORDER.forEach(p=> counts[p]=0);
  for(const t of terms){ if(t.enabled !== false){ counts[t.pos] = (counts[t.pos]||0) + 1; } }

  $tabs.innerHTML = POS_ORDER.map(p=>{
    const active = (p===activePos) ? 'tab active' : 'tab';
    return `<button class="${active}" data-pos="${p}">${p}<span class="count">${counts[p]||0}</span></button>`;
  }).join('');

  $tabs.querySelectorAll('[data-pos]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      activePos = btn.getAttribute('data-pos');
      renderTabs();
      renderTermsTable();
    });
  });
}

// テーブル描画（アクティブな品詞のみ表示、検索適用、読み頭文字でグループ化）
function renderTermsTable(){
  const q = ($search.value||'').trim().toLowerCase();
  const list = terms.filter(t=> t.pos===activePos && t.enabled!==false).filter(t=>{
    if(!q) return true;
    return (t.term||'').toLowerCase().includes(q) || (t.suggest||'').toLowerCase().includes(q);
  });
  // 読みでソート
  list.sort((a,b)=> kanaSortKey(a.yomi).localeCompare(kanaSortKey(b.yomi),'ja'));

  // 件数表示
  $tabCount.textContent = `${list.length} 件`;

  // 行生成（頭文字の行だけ初期表示、それ以外は空欄 ※続き記号なし）
  let html = '';
  let prevInit = null;
  for(const item of list){
    const init = initialKana(item.yomi);
    const initCell = (init!==prevInit) ? `<td class="td-initial" data-init="${init}">${init}</td>` : `<td class="td-initial"></td>`;
    html += `<tr>
      ${initCell}
      <td class="td-word mono">${escapeHtml(item.term)}</td>
      <td class="td-suggest mono">${escapeHtml(item.suggest||'')}</td>
      <td class="td-del"><button class="del" title="削除" data-del="${item.id}">×</button></td>
    </tr>`;
    prevInit = init;
  }
  if(!list.length){
    html = `<tr><td colspan="4" class="muted" style="padding:16px">この品詞には登録がありません。</td></tr>`;
  }
  $termsTbody.innerHTML = html;

  // 削除
  $termsTbody.querySelectorAll('[data-del]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = Number(e.currentTarget.getAttribute('data-del'));
      const idx = terms.findIndex(x=>x.id===id);
      if(idx>=0){ terms.splice(idx,1); saveTerms(); renderTabs(); renderTermsTable(); }
    });
  });
}

// 検索イベント
$search.addEventListener('input', renderTermsTable);

/* =========================
   2: ジャンプ機能（← / →）
========================= */
let issues = [];
let currentHit = -1;
let activeRange = {start:-1,end:-1};

function updateHitState(){
  const total = issues.length;
  const idx = currentHit>=0 ? currentHit+1 : 0;
  $hitState.textContent = total ? `${idx}/${total}` : '';
}

function setActiveRange(start,end){
  // 既存の active を解除
  if(activeRange.start>=0){
    for(let i=activeRange.start;i<activeRange.end;i++){
      const el = $highlight.querySelector(`[data-idx="${i}"]`);
      if(el) el.classList.remove('active');
    }
  }
  activeRange = {start,end};
  // 新規レンジに active 付与
  for(let i=start;i<end;i++){
    const el = $highlight.querySelector(`[data-idx="${i}"]`);
    if(el) el.classList.add('active');
  }
}

function focusHit(i){
  if(i<0 || i>=issues.length) return;
  const it = issues[i];
  setActiveRange(it.start, it.end);
  const el = $highlight.querySelector(`[data-idx="${it.start}"]`);
  if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); }
  updateHitState();
}

function stepHit(delta){
  if(!issues.length) return;
  currentHit = (currentHit + delta + issues.length) % issues.length;
  focusHit(currentHit);
}

$prev.addEventListener('click', ()=> stepHit(-1));
$next.addEventListener('click', ()=> stepHit(1));

/* =========================
   校正 実行
========================= */
function run(){
  const text = $input.value || '';
  const marks = new Array(text.length).fill(false);
  const found = [];

  for(const t of terms){
    if(!t.enabled) continue;
    if(!t.term) continue;
    const re = new RegExp(escapeReg(t.term), 'g');
    let m;
    while((m=re.exec(text))){
      const start = m.index;
      const end = start + (m[0]?.length || 0);
      const {line,col} = toLineCol(text,start);
      found.push({
        ruleId: t.term,
        message: t.suggest ? `『${t.term}』→『${t.suggest}』に統一` : '用語チェック',
        suggest: t.suggest || '',
        line, col, start, end,
        context: getCtx(text,start,end,16)
      });
      for(let i=start;i<end;i++) marks[i]=true;
      if(m[0].length===0) re.lastIndex++;
    }
  }

  // ハイライト
  let html = '';
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    if(marks[i]) html += `<mark class="hit" data-idx="${i}">${escapeHtml(ch)}</mark>`;
    else html += ch==='\n' ? '<br>' : escapeHtml(ch);
  }
  $highlight.innerHTML = html;

  // 一覧
  found.sort((a,b)=> a.start-b.start);
  $tbody.innerHTML = '';
  for(const it of found){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.line}:${it.col}</td>
      <td class="mono">${escapeHtml(it.ruleId)}</td>
      <td>${escapeHtml(it.message)}</td>
      <td class="mono">${escapeHtml(it.suggest)}</td>
      <td class="mono">${escapeHtml(it.context)}</td>`;
    tr.addEventListener('click', ()=> { currentHit = issues.indexOf(it); focusHit(currentHit); });
    $tbody.appendChild(tr);
  }

  issues = found;
  currentHit = issues.length? 0 : -1;
  updateCount(issues.length);
  updateHitState();
  if(currentHit>=0) focusHit(currentHit);
}
function updateCount(n){ $countPill.textContent = `問題: ${n}件`; }

/* =========================
   入出力＆イベント
========================= */
$run.addEventListener('click', run);
$clear.addEventListener('click', ()=>{ $input.value=''; $highlight.innerHTML=''; $tbody.innerHTML=''; issues=[]; currentHit=-1; updateCount(0); updateHitState(); setActiveRange(-1,-1); });

window.addEventListener('keydown', (e)=>{
  if((e.ctrlKey||e.metaKey) && e.key==='Enter') run();
  if(e.altKey && (e.key==='ArrowLeft' || e.key==='ArrowRight')){
    e.preventDefault();
    stepHit(e.key==='ArrowRight' ? 1 : -1);
  }
});

/* =========================
   5: 右ドロワー開閉（◁ / ▷）
========================= */
function openDrawer(){ $drawer.classList.add('open'); $drawer.setAttribute('aria-hidden','false'); $drawerHandle.textContent='▷'; $drawerHandle.setAttribute('aria-label','用語一覧を閉じる'); }
function closeDrawer(){ $drawer.classList.remove('open'); $drawer.setAttribute('aria-hidden','true'); $drawerHandle.textContent='◁'; $drawerHandle.setAttribute('aria-label','用語一覧を開く'); }
function toggleDrawer(){ ($drawer.classList.contains('open') ? closeDrawer : openDrawer)(); }
$drawerHandle.addEventListener('click', toggleDrawer);

/* 便利：ページロード時、タブ状態に合わせて件数初期表示 */
function updateBadgeCounts(){
  const counts = {};
  POS_ORDER.forEach(p=> counts[p]=0);
  for(const t of terms){ if(t.enabled !== false){ counts[t.pos] = (counts[t.pos]||0) + 1; } }
}
</script>
</body>
</html>
