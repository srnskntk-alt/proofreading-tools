<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>校正ツール</title>

  <!-- ✅ ファビコン（同階層に favicon.png を置いてね。更新時は ?v=2 等でキャッシュ回避） -->
  <link rel="icon" href="favicon.png?v=1" type="image/png">

  <style>
    :root{
      --bg:#111; --panel:#181818; --ink:#eee; --muted:#a8b0bb;
      --border:#333; --accent:#7c9cff;
      --hit:#f66;         /* 通常ハイライト（赤） */
      --hit-active:#46e6c2; /* 選択中のみの色（青緑系） */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent);text-decoration:none}
    header{position:sticky;top:0;background:#1a1a1a;border-bottom:1px solid var(--border);z-index:20}
    header .wrap{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;gap:12px;align-items:center}
    h1{margin:0;font-size:18px}
    .container{max-width:1100px;margin:0 auto;padding:12px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .card .hd{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .card .bd{padding:12px}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    button{appearance:none;border:1px solid #3a3a3a;background:#222;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    button:hover{background:#2a2a2a}
    .btn-ghost{background:transparent}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    input[type=text],select,textarea{
      width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:#0b0b0b;color:var(--ink)
    }
    textarea{min-height:160px}
    .out{background:#0b0b0b;border:1px solid var(--border);border-radius:8px;padding:12px;min-height:120px;white-space:pre-wrap;line-height:1.7;max-height:420px;overflow:auto}
    mark.hit{background:transparent;color:var(--hit);padding:0 1px;border-bottom:2px solid var(--hit)}
    mark.hit.active{color:var(--hit-active);border-color:var(--hit-active)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:6px 8px;text-align:left;vertical-align:top}
    thead th{position:sticky;top:0;background:#202020}
    tr:hover{background:#1b1b1b}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#cbd5e1}
    .kbd{font:12px ui-monospace;background:#171717;border:1px solid #2b2b2b;border-bottom-width:2px;padding:2px 6px;border-radius:8px}
    .space{height:8px}

    /* ===== サイドドロワー（用語一覧） ===== */
    .drawer{position:fixed;top:0;right:0;height:100%;width:460px;max-width:92vw;background:#121212;border-left:1px solid var(--border);transform:translateX(100%);transition:transform .25s ease;z-index:40;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawer .hd{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .drawer .bd{padding:10px 12px;overflow:auto}
    .drawerHandle{
      position:fixed;right:0;top:50%;transform:translateY(-50%);
      background:#1a1a1a;border:1px solid var(--border);border-right:none;border-top-left-radius:10px;border-bottom-left-radius:10px;
      padding:10px 8px;color:var(--ink);cursor:pointer;z-index:41
    }
    .x{background:transparent;border:none;color:#ff6b6b;font-weight:700;cursor:pointer}
    .table-terms{min-width:880px;border-collapse:separate;border-spacing:0 6px}
    .table-terms th{font-size:13px;color:#d1d5db;border-bottom:1px solid var(--border);padding:6px 8px;background:#161616;position:sticky;top:0}
    .table-terms td{padding:4px 8px;border-bottom:1px dotted #2a2a2a}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#0b0b0b;border:1px solid #2a2a2a;border-radius:999px;padding:2px 8px}
    .chip .del{color:#fda4af;border:none;background:transparent;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>校正ツール</h1>
      <div class="muted" style="margin-left:auto">
        <span class="kbd">Ctrl/Cmd + Enter</span> で実行 ／
        <span class="kbd">Alt + ←/→</span> で前後ジャンプ
      </div>
    </div>
  </header>

  <main class="container">
    <!-- 入力 -->
    <section class="card">
      <div class="hd">
        <strong>テキスト入力</strong>
        <div class="row" style="align-items:center">
          <button id="runBtn">実行</button>
          <button id="clearBtn" class="btn-ghost">入力クリア</button>
        </div>
      </div>
      <div class="bd">
        <textarea id="input" placeholder="ここに本文を貼り付け"></textarea>
      </div>
    </section>

    <div class="space"></div>

    <!-- 登録フォーム（常時表示） -->
    <section class="card">
      <div class="hd">
        <strong>用語の登録（常時表示）</strong>
        <span class="muted">※ 登録内容はブラウザに保存されます</span>
      </div>
      <div class="bd">
        <div class="row">
          <div class="col">
            <label>ハイライトするキーワード
              <input type="text" id="f-term" placeholder="例：時々">
            </label>
          </div>
          <div class="col">
            <label>推奨表記（任意）
              <input type="text" id="f-suggest" placeholder="例：ときどき">
            </label>
          </div>
          <div class="col">
            <label>読み（ひらがな・必須）
              <input type="text" id="f-yomi" placeholder="例：ときどき">
            </label>
          </div>
          <div class="col">
            <label>品詞
              <select id="f-pos">
                <option>名詞</option>
                <option>動詞</option>
                <option>形容詞</option>
                <option>形容動詞</option>
                <option selected>副詞</option>
                <option>連体詞</option>
                <option>接続詞</option>
                <option>助詞</option>
                <option>助動詞</option>
                <option>感動詞</option>
                <option>記号</option>
                <option>その他</option>
              </select>
            </label>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="addBtn">用語を登録</button>
        </div>
      </div>
    </section>

    <div class="space"></div>

    <!-- 校正結果 -->
    <section class="card">
      <div class="hd">
        <strong>校正結果</strong>
        <div class="row" style="align-items:center">
          <span id="countPill" class="pill">問題: 0件</span>
          <!-- 2. ジャンプボタン（← / →） -->
          <button id="prevBtn" title="前へ（Alt+←）">←</button>
          <button id="nextBtn" title="次へ（Alt+→）">→</button>
          <span id="hitState" class="muted mono" style="min-width:64px;text-align:right"></span>
        </div>
      </div>
      <div class="bd">
        <div id="highlight" class="out"></div>
        <div class="space"></div>
        <div class="out" style="padding:0">
          <table>
            <thead>
              <tr>
                <th style="width:90px">行:列</th>
                <th style="width:140px">ルール</th>
                <th>指摘</th>
                <th style="width:180px">提案</th>
                <th style="width:260px">文脈</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- 5. 右側スライド・用語一覧（品詞ごと / よみ順） -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="hd">
      <strong>用語一覧（品詞カラム / ひらがな順）</strong>
      <button id="closeDrawer" class="btn-ghost">▷ 閉じる</button>
    </div>
    <div class="bd">
      <div class="muted" style="margin-bottom:8px">各用語の「×」で削除できます。</div>
      <div class="out" style="padding:8px;overflow:auto">
        <table id="termsTable" class="table-terms">
          <thead><tr id="posHeadRow"></tr></thead>
          <tbody id="posBody"></tbody>
        </table>
      </div>
    </div>
  </aside>
  <button id="drawerHandle" class="drawerHandle">◁ 用語一覧</button>

<script>
/* =========================
   ストレージ / データ構造
========================= */
const LS_KEY = 'proof_terms.v3';
/** term = {
 *  id: number, term: string, suggest: string,
 *  yomi: string(ひらがな), pos: string, enabled: true
 * }
 */
let terms = [];

const POS_ORDER = [
  '副詞','形容詞','名詞','動詞','形容動詞','連体詞','接続詞','助詞','助動詞','感動詞','記号','その他'
];

/* =========================
   DOM 参照
========================= */
const $input = document.getElementById('input');
const $highlight = document.getElementById('highlight');
const $tbody = document.getElementById('tableBody');
const $countPill = document.getElementById('countPill');
const $hitState = document.getElementById('hitState');

const $run = document.getElementById('runBtn');
const $clear = document.getElementById('clearBtn');
const $prev = document.getElementById('prevBtn');
const $next = document.getElementById('nextBtn');

const $fTerm = document.getElementById('f-term');
const $fSug  = document.getElementById('f-suggest');
const $fYomi = document.getElementById('f-yomi');
const $fPos  = document.getElementById('f-pos');
const $add   = document.getElementById('addBtn');

const $drawer = document.getElementById('drawer');
const $drawerHandle = document.getElementById('drawerHandle');
const $closeDrawer = document.getElementById('closeDrawer');
const $posHeadRow = document.getElementById('posHeadRow');
const $posBody = document.getElementById('posBody');

/* =========================
   初期化
========================= */
(function init(){
  const raw = localStorage.getItem(LS_KEY);
  if(raw){ try{ terms = JSON.parse(raw) || []; }catch{} }
  renderTermsTable();
})();

/* =========================
   ユーティリティ
========================= */
function saveTerms(){ localStorage.setItem(LS_KEY, JSON.stringify(terms)); }
function escapeHtml(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function csvEscape(s){ if(s==null) return ''; s=String(s).replace(/"/g,'""'); return `"${s}"`; }
function toLineCol(text, index){ let line=1,col=1; for(let i=0;i<index;i++){ if(text[i]==='\n'){ line++; col=1; } else col++; } return {line,col}; }
function getCtx(text, start, end, pad=16){ const s=Math.max(0,start-pad), e=Math.min(text.length,end+pad); const L=text.slice(s,start), M=text.slice(start,end), R=text.slice(end,e); return `${L}[${M}]${R}`.replace(/\n/g,'⏎'); }
function escapeReg(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function isHiragana(s){ return /^[ぁ-ゖー]+$/.test(s); } // ひらがな + 長音

/* =========================
   3 & 7: 用語登録 / 一覧
========================= */
// 登録
$add.addEventListener('click', ()=>{
  const t = ($fTerm.value||'').trim();
  const y = ($fYomi.value||'').trim();
  if(!t) return alert('「ハイライトするキーワード」を入力してください');
  if(!y) return alert('「読み（ひらがな）」は必須です');
  if(!isHiragana(y)) return alert('読みは ひらがな で入力してください');

  const obj = { id: Date.now(), term: t, suggest: ($fSug.value||'').trim(), yomi: y, pos: $fPos.value, enabled: true };
  terms.push(obj);
  saveTerms(); renderTermsTable();
  $fTerm.value = $fSug.value = $fYomi.value = '';
});

// 一覧（右ドロワー）の描画：品詞カラム×よみ順
function renderTermsTable(){
  // 品詞→配列の辞書化
  const groups = {};
  POS_ORDER.forEach(p=> groups[p]=[]);
  for(const t of terms){ (groups[t.pos] || (groups[t.pos]=[])).push(t); }
  POS_ORDER.forEach(p=> groups[p].sort((a,b)=> a.yomi.localeCompare(b.yomi,'ja')));

  // ヘッダ
  $posHeadRow.innerHTML = POS_ORDER.map(p=> `<th>${p}</th>`).join('');

  // 行数（各品詞の最大件数）
  const rows = Math.max(0, ...POS_ORDER.map(p=> groups[p].length));
  let bodyHtml = '';
  for(let r=0;r<rows;r++){
    bodyHtml += '<tr>';
    for(const pos of POS_ORDER){
      const item = groups[pos][r];
      if(item){
        bodyHtml += `<td>
          <span class="chip mono">${escapeHtml(item.term)}${item.suggest?`<span class="muted">→</span> ${escapeHtml(item.suggest)}`:''}
            <button class="del" title="削除" data-del="${item.id}">×</button>
          </span>
          <div class="muted" style="font-size:12px;margin-top:2px">よみ：${escapeHtml(item.yomi)}</div>
        </td>`;
      }else{
        bodyHtml += '<td></td>';
      }
    }
    bodyHtml += '</tr>';
  }
  $posBody.innerHTML = bodyHtml;

  // 削除ハンドラ
  $posBody.querySelectorAll('[data-del]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = Number(e.currentTarget.getAttribute('data-del'));
      const idx = terms.findIndex(x=>x.id===id);
      if(idx>=0){ terms.splice(idx,1); saveTerms(); renderTermsTable(); }
    });
  });
}

/* =========================
   2: ジャンプ機能（← / →）
========================= */
let issues = [];
let currentHit = -1;
let activeRange = {start:-1,end:-1};

function updateHitState(){
  const total = issues.length;
  const idx = currentHit>=0 ? currentHit+1 : 0;
  document.getElementById('hitState').textContent = total ? `${idx}/${total}` : '';
}

function setActiveRange(start,end){
  // 既存の active を解除
  if(activeRange.start>=0){
    for(let i=activeRange.start;i<activeRange.end;i++){
      const el = $highlight.querySelector(`[data-idx="${i}"]`);
      if(el) el.classList.remove('active');
    }
  }
  activeRange = {start,end};
  // 新規レンジに active 付与
  for(let i=start;i<end;i++){
    const el = $highlight.querySelector(`[data-idx="${i}"]`);
    if(el) el.classList.add('active');
  }
}

function focusHit(i){
  if(i<0 || i>=issues.length) return;
  const it = issues[i];
  setActiveRange(it.start, it.end);
  const el = $highlight.querySelector(`[data-idx="${it.start}"]`);
  if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); }
  updateHitState();
}

function stepHit(delta){
  if(!issues.length) return;
  currentHit = (currentHit + delta + issues.length) % issues.length;
  focusHit(currentHit);
}

$prev.addEventListener('click', ()=> stepHit(-1));
$next.addEventListener('click', ()=> stepHit(1));

/* =========================
   校正 実行
========================= */
function run(){
  const text = $input.value || '';
  const marks = new Array(text.length).fill(false);
  const found = [];

  // 用語の literal マッチ（語境界の区別は日本語では基本なし）
  for(const t of terms){
    if(!t.enabled) continue;
    if(!t.term) continue;
    const re = new RegExp(escapeReg(t.term), 'g'); // 大文字小文字は日本語なので省略
    let m;
    while((m=re.exec(text))){
      const start = m.index;
      const end = start + (m[0]?.length || 0);
      const {line,col} = toLineCol(text,start);
      found.push({
        ruleId: t.term,
        message: t.suggest ? `『${t.term}』→『${t.suggest}』に統一` : '用語チェック',
        suggest: t.suggest || '',
        line, col, start, end,
        context: getCtx(text,start,end,16)
      });
      for(let i=start;i<end;i++) marks[i]=true;
      if(m[0].length===0) re.lastIndex++;
    }
  }

  // ハイライト描画（選択中のみ色変更できるよう、1文字ずつ mark）
  let html = '';
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    if(marks[i]) html += `<mark class="hit" data-idx="${i}">${escapeHtml(ch)}</mark>`;
    else html += ch==='\n' ? '<br>' : escapeHtml(ch);
  }
  $highlight.innerHTML = html;

  // 一覧描画
  found.sort((a,b)=> a.start-b.start);
  $tbody.innerHTML = '';
  for(const it of found){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.line}:${it.col}</td>
      <td class="mono">${escapeHtml(it.ruleId)}</td>
      <td>${escapeHtml(it.message)}</td>
      <td class="mono">${escapeHtml(it.suggest)}</td>
      <td class="mono">${escapeHtml(it.context)}</td>`;
    tr.addEventListener('click', ()=> { currentHit = issues.indexOf(it); focusHit(currentHit); });
    $tbody.appendChild(tr);
  }

  issues = found;
  currentHit = issues.length? 0 : -1;
  updateCount(issues.length);
  updateHitState();
  if(currentHit>=0) focusHit(currentHit);
}

function updateCount(n){ $countPill.textContent = `問題: ${n}件`; }

/* =========================
   入出力＆イベント
========================= */
$run.addEventListener('click', run);
$clear.addEventListener('click', ()=>{ $input.value=''; $highlight.innerHTML=''; $tbody.innerHTML=''; issues=[]; currentHit=-1; updateCount(0); updateHitState(); setActiveRange(-1,-1); });

window.addEventListener('keydown', (e)=>{
  if((e.ctrlKey||e.metaKey) && e.key==='Enter') run();
  if(e.altKey && (e.key==='ArrowLeft' || e.key==='ArrowRight')){
    e.preventDefault();
    stepHit(e.key==='ArrowRight' ? 1 : -1);
  }
});

/* =========================
   5: 右ドロワー開閉
========================= */
function openDrawer(){ $drawer.classList.add('open'); $drawer.setAttribute('aria-hidden','false'); }
function closeDrawer(){ $drawer.classList.remove('open'); $drawer.setAttribute('aria-hidden','true'); }
$drawerHandle.addEventListener('click', openDrawer);
$closeDrawer.addEventListener('click', closeDrawer);

/* 体験用のプリセットが何もなければ、1つだけサンプルを用意 */
if(!terms.length){
  terms = [
    { id: 1, term:'...', suggest:'……', yomi:'てんてんてん', pos:'記号', enabled:true },
    { id: 2, term:'時々', suggest:'ときどき', yomi:'ときどき', pos:'副詞', enabled:true }
  ];
  saveTerms();
  renderTermsTable();
}
</script>
</body>
</html>
